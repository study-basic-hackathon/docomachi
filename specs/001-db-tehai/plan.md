# Implementation Plan: 麻雀配牌データ取得と初期登録

**Branch**: `001-db-tehai` | **Date**: 2026-02-28 | **Spec**: `specs/001-db-tehai/spec.md`  
**Input**: Feature specification from `specs/001-db-tehai/spec.md`

**Note**: This plan is generated by `/speckit.plan` for the Docomachi project.

## Summary

麻雀牌の表現ルールに従った配牌データと当たり牌をDynamoDBに保存し、内部向けのランダム配牌取得エンドポイントから1件取得できるようにする。  
あわせて、国士無双13面待ちと純正九蓮宝燈の初期データをJSONとして用意し、運営が手順どおりに投入できるようにする。  
バックエンドはAWS Amplify Gen2/AppSync/DynamoDB/Lambda（TypeScript）構成とし、本機能はバックエンド内部／運営ツール専用のAPIとして実装する。  
US1 の実装では Amplify Data が自動生成する `MahjongHand` モデル用 GraphQL API（例: `listMahjongHands`）を利用し、専用のカスタム GraphQL スキーマやクエリ定義は追加しない。

## Technical Context

**Language/Version**: TypeScript（AppSync Resolvers / Lambda, Next.js フロントと統一）  
**Primary Dependencies**: AWS Amplify Gen2, AWS AppSync, AWS Lambda, AWS SDK for JavaScript (v3)  
**Storage**: DynamoDB（単一テーブルに `MahjongHand` アイテムを格納）  
**Testing**: Jest（ユニットテストをミニマムに作成）  
**Target Platform**: AWS（AppSync + Lambda + DynamoDB のサーバレス構成）  
**Project Type**: web（Next.js フロントエンド + サーバレスバックエンド）  
**GraphQL**: Amplify Data の自動生成 GraphQL API を利用（US1 は自動生成クエリ経由で実現）  
**Performance Goals**: ランダム配牌取得リクエストに対して体感 1 秒以内に応答（SC-002 に準拠）  
**Constraints**: p95 レイテンシ < 500ms（AppSync〜DynamoDB 経由の1往復）、1リクエストあたりの読み込みコストを最小限に抑える  
**Scale/Scope**: 初期は数十〜数百件規模の配牌データを想定（クイズ問題のバリエーション用）。将来的な増加にも対応できるよう、テーブル設計はスケール可能なパターンを採用する。

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

- ✅ **I. AWS Amplify Gen2 ベースの開発**  
  - バックエンドは AppSync + DynamoDB + Lambda（すべてTypeScript）で構成し、Amplify Gen2 を利用する前提に合致している。
- ✅ **II. テストとコード品質**  
  - 本機能に対しても Jest によるミニマムなテストケース（ランダム取得の挙動、初期データ投入ロジックの正常系・簡易異常系）を用意する。  
  - 既存の ESLint/Prettier + husky に準拠してコード品質を保つ。
- ✅ **III. タスク開始手順**  
  - `001-db-tehai` ブランチで作業しており、main から分岐している前提に問題はない。
- ✅ **IV. タスク範囲と PR / トークン**  
  - 本Planは最終的にPR作成までを含むタスクとして扱う。GitHubトークン利用が必要な処理は予定していない。

→ すべての憲法ゲートを満たしているため、本機能の設計・実装を進めて問題ない。

## Project Structure

### Documentation (this feature)

```text
specs/[###-feature]/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```text
specs/
├── 001-db-tehai/
│   ├── spec.md
│   ├── plan.md
│   ├── research.md
│   ├── data-model.md
│   ├── quickstart.md
│   └── contracts/

amplify/
├── backend/
│   ├── api/        # AppSync GraphQL API（本機能のクエリ/ミューテーションを追加）
│   └── function/   # 必要に応じてResolver用Lambdaを追加

src/                # Next.js フロントエンド
├── pages/
├── components/
└── lib/
```

**Structure Decision**: Docomachi 既存構成（Next.js + Amplify Gen2 + AppSync + DynamoDB）に従い、本featureは `specs/001-db-tehai` 配下にドキュメント類を配置し、バックエンドの変更は `amplify/backend/api` および必要であれば `amplify/backend/function` に対する拡張として実装する。

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| [e.g., 4th project] | [current need] | [why 3 projects insufficient] |
| [e.g., Repository pattern] | [specific problem] | [why direct DB access insufficient] |
