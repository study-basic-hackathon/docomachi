# Feature Specification: 麻雀配牌データ取得と初期登録

**Feature Branch**: `001-db-tehai`  
**Created**: 2026-02-28  
**Status**: Draft  
**Input**: User description: "麻雀牌の表現ルールに従って、配牌と当たり牌を保持するデータストアを用意し、ランダムに1件取得するエンドポイントと、国士無双13面待ち・純正九蓮宝燈の初期データ登録手順を用意する。"

## Clarifications

### Session 2026-02-28

- Q: ランダム配牌取得エンドポイントは誰から呼び出される想定か？ → A: バックエンド内部／運営用ツールのみからの認証済みアクセス

## User Scenarios & Testing *(mandatory)*

### User Story 1 - ランダム配牌を取得したい (Priority: P1)

麻雀問題コンテンツを作成する担当者として、アプリやツールからランダムな配牌データとその当たり牌を取得できるようにしたい。  
これにより、常に同じ問題ではなく、複数パターンの配牌を使った問題出題ができる。

**Why this priority**: 本機能の中心的な価値であり、ランダムな配牌取得ができないとデータストア構築の意味が薄れるため。

**Independent Test**: データストアに複数件の配牌データを登録した状態で、エンドポイントを呼び出し、常に1件の配牌＋当たり牌が返却されること、および複数回の呼び出しで異なるIDのデータが取得できることを確認する。

**Acceptance Scenarios**:

1. **Given** データストアに有効な配牌データが複数件登録されている  
   **When** クライアントが「ランダム配牌取得」エンドポイントを1回呼び出す  
   **Then** 配牌13枚分の牌リストと当たり牌リスト、および一意なIDが1件分返却される
2. **Given** データストアに有効な配牌データが10件以上登録されている  
   **When** クライアントが「ランダム配牌取得」エンドポイントを10回連続で呼び出す  
   **Then** 少なくとも2種類以上の異なるIDの配牌データが返却される

---

### User Story 2 - 役満の例題データを初期投入したい (Priority: P1)

運営担当者として、国士無双13面待ちと純正九蓮宝燈のような代表的な役満の配牌データを、提供された手順どおりに初期投入したい。  
これにより、リリース直後から象徴的な例題コンテンツをすぐに活用できる。

**Why this priority**: サービスの世界観を伝える象徴的なデータであり、初期コンテンツとして重要なため。

**Independent Test**: 手順書のとおりに操作を行った場合に、指定された2種類の役満データが正しい牌表現・当たり牌で登録されていることを確認する。

**Acceptance Scenarios**:

1. **Given** 初期状態でデータストアに役満データが未登録である  
   **When** 手順書に記載された手順に従って初期データ投入を行う  
   **Then** 国士無双13面待ち、純正九蓮宝燈の2件の配牌データが登録されていることが確認できる
2. **Given** 初期データ投入後に「ランダム配牌取得」エンドポイントを複数回呼び出す  
   **When** 取得結果のIDおよび配牌内容を確認する  
   **Then** 少なくとも一度は国士無双13面待ち、または純正九蓮宝燈のいずれかが取得できる

---

### User Story 3 - 配牌データの品質を確認したい (Priority: P3)

品質管理担当者として、登録されている配牌データが牌表現ルールに従っており、不正な牌や枚数過多が含まれていないことを確認したい。  
これにより、利用者に誤った麻雀情報を提供するリスクを減らしたい。

**Why this priority**: 不正な牌表現や誤った当たり牌が公開されると、ユーザー体験や信頼性に悪影響があるため。

**Independent Test**: 登録されている全データに対して検証処理を実行し、牌表現や枚数ルールに反するデータが無いことをレポートで確認できること。

**Acceptance Scenarios**:

1. **Given** データストアに複数件の配牌データが登録されている  
   **When** 牌表現ルールと枚数チェックを含む検証処理を実行する  
   **Then** すべてのレコードがルールに準拠している場合は「問題なし」と判定される
2. **Given** 意図的に不正な牌表現や14枚以上の配牌を含むテストデータを1件登録する  
   **When** 同じ検証処理を実行する  
   **Then** 不正なレコードが特定され、原因（不正な牌表現／枚数超過）がレポートとして分かる

---

### Edge Cases

- 配牌の枚数が13枚より少ない／多いデータが登録されている場合は、ランダム取得の対象外とし、検証で検知できること  
- 許可されていない牌表現（例: 存在しない数字や誤ったアルファベット）が含まれる場合は、登録時または検証時にエラーとして扱われること  
- データストアに有効な配牌データが1件も存在しない状態でランダム取得を呼び出した場合は、分かりやすいエラーメッセージで「配牌データ未登録」を通知すること  
- 特定の役（国士無双13面待ち、純正九蓮宝燈）に関する初期データのみが登録されている状態でも、通常のランダム取得として問題なく動作すること

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは、麻雀の配牌データを永続的に保存するデータストアを保持し、各レコードに以下の情報を持たせなければならない。  
  - 一意なID  
  - 手牌：要素数13の牌表現の配列（例: `1s`, `9m`, `ton` など、定義済みルールに従う文字列）  
  - 当たり牌：牌表現の配列（0個以上）
- **FR-002**: システムは、登録されている有効な配牌レコードの中から、1件をランダムに選択して返却するエンドポイントを提供しなければならない。  
  - 応答には「ID」「13枚の配牌」「当たり牌の配列」が含まれること  
  - レコードごとの出現確率は極端に偏らないように設計されていること
- **FR-003**: システムは、索子・萬子・筒子・字牌の牌表現ルールに従っているかを検証し、許可されていない文字列が含まれる配牌データは登録・利用できないようにしなければならない。  
  - 索子: `1s`〜`9s`  
  - 萬子: `1m`〜`9m`  
  - 筒子: `1p`〜`9p`  
  - 字牌: `ton`, `nan`, `sha`, `pe`, `haku`, `hatsu`, `chun`
- **FR-004**: システムは、運営担当者が国士無双13面待ちおよび純正九蓮宝燈の配牌データを、構造化されたデータ形式（例: JSON）で準備し、決められた手順に従って初期登録できるようにしなければならない。  
  - 初期登録用のデータには、配牌13枚と当たり牌、および識別可能なIDが含まれること  
  - 手順書どおりに実施した場合に、二重登録や欠落が発生しないこと
- **FR-005**: システムは、初期登録後も新しい配牌データを追加入力できるようにし、既存データを削除しない限りはランダム取得の対象として利用できるようにしなければならない。
- **FR-006**: システムは、ランダム取得エンドポイント呼び出し時にエラーが発生した場合（例: データ未登録、内部エラーなど）には、利用者が原因を推測できるレベルの分かりやすいエラーメッセージを返却しなければならない。
- **FR-007**: システムは、登録済み配牌データの件数や、検証で検出された不正データ数を確認できるような集計・確認手段（画面またはレポート）を提供しなければならない。
- **FR-008**: システムは、ランダム配牌取得エンドポイントへのアクセスをバックエンド内部サービスおよび運営用管理ツールなどの信頼されたコンポーネントに限定し、認証済みクライアントからのみ呼び出し可能としなければならない。

### Key Entities *(include if feature involves data)*

- **MahjongHand**:  
  麻雀の1手牌を表すエンティティ。  
  - 属性: ID（一意な識別子）、手牌（13枚の牌表現の配列）、当たり牌（牌表現の配列）、作成日時、更新日時 など  
  - 関係: 初期データ投入手順や将来の編集機能から参照される

- **InitialHandDataset**:  
  初期投入される役満配牌データの集合を表す概念的なエンティティ。  
  - 属性: データセット名（例: 「国士無双13面待ち」「純正九蓮宝燈」）、説明テキスト、含まれる `MahjongHand` のID一覧  
  - 関係: 運営向けドキュメントや運用手順から参照される

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 運営担当者が、提供された初期データ投入手順に従って作業を行った場合、30分以内に国士無双13面待ちと純正九蓮宝燈の2件の配牌データを登録完了できる。  
- **SC-002**: ランダム配牌取得エンドポイントを通常の利用条件下で呼び出した際、ユーザーが結果を画面で確認するまでの体感時間がおおむね1秒以内である。  
- **SC-003**: 登録された配牌データに対して検証を実行した際、リリース時点で不正な牌表現や13枚以外の配牌が含まれるレコードが0件である。  
- **SC-004**: リリース後1カ月以内に、配牌データの不足や誤りに起因する問い合わせ・サポート対応件数が全問い合わせの5%未満に収まっている。

## Assumptions

- 配牌データおよび当たり牌の表現形式は、文字列ベースの牌コードで統一される。  
- 実装ではクラウド提供のNoSQL型データストアを利用することを想定しているが、仕様上は特定のサービス名に依存しない。  
- 本機能では、役の判定ロジックそのもの（どの配牌がどの役に該当するかを自動判定する処理）は範囲外とし、あらかじめ用意された正しい配牌データが登録される前提とする。
